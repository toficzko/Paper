From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Tue, 2 Jan 2018 00:31:26 -0500
Subject: [PATCH] Fill Profile Property Events

Allows plugins to populate profile properties from local sources to avoid calls out to Mojang API
to fill in textures for example.

If Mojang API does need to be hit, event fire so you can get the results.

This is useful for implementing a ProfileCache for Player Skulls

diff --git a/src/main/java/io/papermc/paper/profile/PaperMinecraftSessionService.java b/src/main/java/io/papermc/paper/profile/PaperMinecraftSessionService.java
index 748bd743a2745610f7c5d6449af94cdf108793e5..db325f53e8842da4e41b22b319c15a77315f5bfe 100644
--- a/src/main/java/io/papermc/paper/profile/PaperMinecraftSessionService.java
+++ b/src/main/java/io/papermc/paper/profile/PaperMinecraftSessionService.java
@@ -1,6 +1,8 @@
 package io.papermc.paper.profile;
 
 import com.mojang.authlib.Environment;
+import io.papermc.paper.event.profile.FillProfileEvent;
+import io.papermc.paper.event.profile.PreFillProfileEvent;
 import com.mojang.authlib.GameProfile;
 import com.mojang.authlib.minecraft.MinecraftProfileTexture;
 import com.mojang.authlib.yggdrasil.YggdrasilAuthenticationService;
@@ -20,7 +22,15 @@ public class PaperMinecraftSessionService extends YggdrasilMinecraftSessionServi
 
     @Override
     public GameProfile fillProfileProperties(GameProfile profile, boolean requireSecure) {
-        return super.fillProfileProperties(profile, requireSecure);
+        CraftPlayerProfile playerProfile = (CraftPlayerProfile) CraftPlayerProfile.asBukkitMirror(profile);
+        new PreFillProfileEvent(playerProfile).callEvent();
+        profile = playerProfile.getGameProfile();
+        if (profile.isComplete() && profile.getProperties().containsKey("textures")) {
+            return profile;
+        }
+        GameProfile gameProfile = super.fillProfileProperties(profile, requireSecure);
+        new FillProfileEvent(CraftPlayerProfile.asBukkitMirror(gameProfile)).callEvent();
+        return gameProfile;
     }
 
     @Override
