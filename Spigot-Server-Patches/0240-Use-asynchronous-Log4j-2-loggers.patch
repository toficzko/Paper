From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Minecrell <minecrell@minecrell.net>
Date: Tue, 17 Jul 2018 16:42:17 +0200
Subject: [PATCH] Use asynchronous Log4j 2 loggers


diff --git a/pom.xml b/pom.xml
index e1081341b4e4f63c2ff66aed40ebc6bc126eaf10..d5c5ad1d36667aaf4f54150b257474932542fb37 100644
--- a/pom.xml
+++ b/pom.xml
@@ -86,6 +86,13 @@
                 </exclusion>
             </exclusions>
         </dependency>
+        <!-- Paper - Async loggers -->
+        <dependency>
+            <groupId>com.lmax</groupId>
+            <artifactId>disruptor</artifactId>
+            <version>3.4.2</version>
+            <scope>runtime</scope>
+        </dependency>
         <dependency>
             <groupId>org.ow2.asm</groupId>
             <artifactId>asm</artifactId>
diff --git a/src/main/java/io/papermc/paper/log/LogFullPolicy.java b/src/main/java/io/papermc/paper/log/LogFullPolicy.java
new file mode 100644
index 0000000000000000000000000000000000000000..7b6e3c841b79de97a994aed7def568f8b5c4a0a0
--- /dev/null
+++ b/src/main/java/io/papermc/paper/log/LogFullPolicy.java
@@ -0,0 +1,17 @@
+package io.papermc.paper.log;
+
+import org.apache.logging.log4j.Level;
+import org.apache.logging.log4j.core.async.AsyncQueueFullPolicy;
+import org.apache.logging.log4j.core.async.EventRoute;
+
+public final class LogFullPolicy implements AsyncQueueFullPolicy {
+
+    /*
+     * Prevents log calls being logged out of order when the log queue is full.
+     */
+
+    @Override
+    public EventRoute getRoute(final long backgroundThreadId, final Level level) {
+        return EventRoute.ENQUEUE;
+    }
+}
diff --git a/src/main/resources/log4j2.component.properties b/src/main/resources/log4j2.component.properties
index 0694b21465fb9e4164e71862ff24b62241b191f2..d7cb84477190886dc3fc4e0208effb53c2ade6a8 100644
--- a/src/main/resources/log4j2.component.properties
+++ b/src/main/resources/log4j2.component.properties
@@ -1 +1,3 @@
+Log4jContextSelector=org.apache.logging.log4j.core.async.AsyncLoggerContextSelector
+log4j2.AsyncQueueFullPolicy="io.papermc.paper.log.LogFullPolicy"
 log4j.skipJansi=true
