From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: BillyGalbreath <blake.galbreath@gmail.com>
Date: Tue, 8 Dec 2020 20:14:20 -0600
Subject: [PATCH] Fix curing zombie villager discount exploit

This fixes the exploit used to gain absurd trading discounts with infecting
and curing a villager on repeat by simply resetting the relevant part of
the reputation when it is cured.

diff --git a/src/main/java/io/papermc/paper/PaperWorldConfig.java b/src/main/java/io/papermc/paper/PaperWorldConfig.java
index ffcb6ba6701efd02d9156300d039cd84cf61963d..1b469cb2a07640d6424fa7aecfec4c7b66e719ce 100644
--- a/src/main/java/io/papermc/paper/PaperWorldConfig.java
+++ b/src/main/java/io/papermc/paper/PaperWorldConfig.java
@@ -715,4 +715,9 @@ public class PaperWorldConfig {
     private void fixClimbingBypassingCrammingRule() {
         fixClimbingBypassingCrammingRule = getBoolean("fix-climbing-bypassing-cramming-rule", fixClimbingBypassingCrammingRule);
     }
+
+    public boolean fixCuringZombieVillagerDiscountExploit = true;
+    private void fixCuringExploit() {
+        fixCuringZombieVillagerDiscountExploit = getBoolean("game-mechanics.fix-curing-zombie-villager-discount-exploit", fixCuringZombieVillagerDiscountExploit);
+    }
 }
diff --git a/src/main/java/net/minecraft/world/entity/ai/gossip/Reputation.java b/src/main/java/net/minecraft/world/entity/ai/gossip/Reputation.java
index 538bfbfb32c6cabd4c061f382fae77cb47a35366..190e30b0a0191442339205c421822819dbd96b31 100644
--- a/src/main/java/net/minecraft/world/entity/ai/gossip/Reputation.java
+++ b/src/main/java/net/minecraft/world/entity/ai/gossip/Reputation.java
@@ -223,6 +223,7 @@ public class Reputation {
 
         }
 
+        public final void removeReputationForType(ReputationType reputationType) { this.b(reputationType); } // Paper - OBFHELPER
         public void b(ReputationType reputationtype) {
             this.a.removeInt(reputationtype);
         }
diff --git a/src/main/java/net/minecraft/world/entity/npc/EntityVillager.java b/src/main/java/net/minecraft/world/entity/npc/EntityVillager.java
index a3d21b1ceae00681ea85bd4ad6027c42d3bf83ef..52d6c3b701e183fe4d7709bd7eb469d2c2193264 100644
--- a/src/main/java/net/minecraft/world/entity/npc/EntityVillager.java
+++ b/src/main/java/net/minecraft/world/entity/npc/EntityVillager.java
@@ -1007,6 +1007,15 @@ public class EntityVillager extends EntityVillagerAbstract implements Reputation
     @Override
     public void a(ReputationEvent reputationevent, Entity entity) {
         if (reputationevent == ReputationEvent.a) {
+            // Paper start - fix MC-181190
+            if (world.paperConfig.fixCuringZombieVillagerDiscountExploit) {
+                final Reputation.a playerReputation = this.getReputation().getReputations().get(entity.getUniqueID());
+                if (playerReputation != null) {
+                    playerReputation.removeReputationForType(ReputationType.MAJOR_POSITIVE);
+                    playerReputation.removeReputationForType(ReputationType.MINOR_POSITIVE);
+                }
+            }
+            // Paper end
             this.by.a(entity.getUniqueID(), ReputationType.MAJOR_POSITIVE, 20);
             this.by.a(entity.getUniqueID(), ReputationType.MINOR_POSITIVE, 25);
         } else if (reputationevent == ReputationEvent.e) {
